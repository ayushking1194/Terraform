#cloud-config
package_update: true

write_files:
  - path: /root/bootstrap.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e

      apt-get update && apt-get install -y containerd apt-transport-https curl

      mkdir -p /etc/containerd
      containerd config default > /etc/containerd/config.toml
      systemctl restart containerd

      curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key |
        gpg --dearmor -o /usr/share/keyrings/k8s.gpg

      echo "deb [signed-by=/usr/share/keyrings/k8s.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" \
        > /etc/apt/sources.list.d/kubernetes.list

      apt-get update
      apt-get install -y kubelet kubeadm kubectl
      apt-mark hold kubelet kubeadm kubectl

      kubeadm init --pod-network-cidr=192.168.0.0/16

      mkdir -p /root/.kube
      cp /etc/kubernetes/admin.conf /root/.kube/config

      kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/calico.yaml

      kubeadm token create --print-join-command > /root/join.sh
      chmod +x /root/join.sh

runcmd:
  - bash /root/bootstrap.sh